<!DOCTYPE html>
<html lang="zh_CN">
<head>
    <meta charset="UTF-8">  
    <title i18n="i18n.title">联想语音开放平台</title>
    <meta http-equiv="Imagetoolbar" content="no" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=yes, viewport-fit=cover"  />
    <link rel="icon" href="../common/images/favicon.ico" type="image/x-icon" />
    <link href="../framework/bootstrap/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="../common/css/head.css?version=2.0" rel="stylesheet"/>
    <link href="css/tts.css?version=2.0" rel="stylesheet"/>
	<link rel="stylesheet" href="../welcome/css/all.css">
    <link rel="stylesheet" href="../common/css/animate.min.css">
    <link rel="stylesheet" href="../common/css/popup.css">
    <link rel="stylesheet" href="../common/css/animate.min_4.0.css"/>
    <script type="text/javascript" src="../common/mixjs/commurl.js?version=2.0"></script>
    <script type="text/javascript" src="../common/mixjs/pagetop.js?version=2.0"></script>
	<script type="text/javascript" src="../framework/jquery/jquery-3.2.1.min.js"></script>
    <script type="text/javascript" src="../framework/bootstrap/js/bootstrap.min.js"></script>
    <script src="../common/js/jquery.base64.js"></script>
    <script src="../common/js/jquery.i18n.js"></script> 
	<script src="../common/js/com.js"></script>
    <script src="../common/mixjs/popup.js"></script>
    <script src="./mixjs/axios.min.js"></script>
    <style>
        #eui-main-footer{
            position: fixed;
            bottom: 0;
        }
        .textarea_box{
            min-height: 206px;
        }
        .wait-btn{
            display: none;
        }
    </style>
</head>
<body>
	<div class="dis_flex">
		<div class="nav-title">
			<nav class="navbar navbar-default navbar-inverse navbar-fixed-top" role="navigation">
			</nav>
			<p class="recognise_title" i18n='i18n.synthesis'>语音合成</p>
			<div class="bg_div"></div>
		</div>
		<div class="eui-main-body">
            <div class="content-title" i18n="i18n.proEx">产品体验</div>
            <div class="content-box">
                <div class="content-top">
                    <span class="hint" i18n="i18n.inputText">请输入需要合成的文本</span>
                    <span class="rand-btn" id="randBtn" i18n="i18n.random">随机示例</span>
                </div>
                <div class="text-box">
                    <div class="textarea_box" id="textarea_box">
                        <textarea class="content-text" id="textarea" onkeyup="setShowLength(this, 150, 'number');" maxlength="150" i18n-only="placeholder" i18n="i18n.ttsText" placeholder="在这里你可以输入任意想要说的话，我们会将文字信息合成自然、生动的人声。"></textarea>
                    </div>
                    <div class="hint-num">
                        <span i18n="i18n.enterword">你还可以输入</span>
                        <span id="number">150</span>
                        <span i18n="i18n.ttsWords">个字</span>
                    </div>
                </div>
                <div class="content-btn">
                    <div class="play-box">
                        <img src="./images/play.png" id="play-img">
                        <button id="play-btn" i18n="i18n.ttsplay">播放</button>
                        <button class="wait-btn" id="wait-btn" i18n="i18n.ttspause">暂停</button>
                        <div class="loading">
                            <span></span>
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
					<audio id="bgMusic">
							您的浏览器不支持 audio 标签。
					</audio>
                </div>
            </div>
            
		</div>
			
			<div id="eui-main-footer" class="footer-bgcolor">
            </div>
	</div>


  

</body>

<script>
loadTop("product");
var pause = document.getElementById('play-btn')
var pauseImg = document.getElementById('play-img')
var bgm = document.getElementById('bgMusic')
var number = document.getElementById('number')
var randBtn = document.getElementById('randBtn')
var textv
var accountid = $.base64.decode(window.localStorage.getItem('acd'))
var accountidd = window.localStorage.getItem('acd')
var lenkey = $.base64.decode(window.localStorage.getItem('lk'))
var secrkey = $.base64.decode(window.localStorage.getItem('sk'))
var user = navigator.userAgent.match(/(iPhone|iPod|Android|ios)/i)
var statu = 0
var n = 0
var arrList
    $('.play-box').click(function(){
		textv = $('#textarea').val()
		if (accountidd == "" || accountidd == null || accountidd.length == 0) {
			if(getCookie('grycan.cn.bLang') =='english'){
                Popup.Nalert("Please login first！")
            }else{
                Popup.Nalert("请先登录！")
            }
		}else if(textv == ''){
            // Popup.Nalert('识别内容不能为空')
            $('.hint').addClass('animate__animated animate__shakeX')
            setTimeout(function(){
                $('.hint').removeClass('animate__animated animate__shakeX')
            },1000)
		}else if (window.navigator.userAgent.indexOf("MSIE")>=1){
            $('#textarea').val('此浏览器不支持音频播放')
        }else{
            $('#play-btn').css('display','none')
            $('#wait-btn').css('display','none')
            $('#play-img').css('display','none')
            $('.loading').css('display','block')
            XMLhttp()
			
		}
    })
function setShowLength(obj, maxlength, id) {
	var rem = maxlength - obj.value.length; 
	var wid = id; 
	if (rem < 0){ 
		rem = 0; 
	} 
	document.getElementById(wid).innerHTML = rem; 
} 

randBtn.addEventListener('click',function(){
    if(getCookie('grycan.cn.bLang') =='english'){
    arrList = ['150 meters ahead, please turn left at the end of the road and enter Houchang village road.',
                'There are 27 people waiting in line ahead.']
    }else{
        arrList = ['前方150米，请在道路尽头左转，进入后厂村路。','前面还有27名等候人员排队','两岸猿声啼不住，轻舟已过万重山','白日依山尽，黄河入海流。欲穷千里目，更上一层楼。']
    }
    n = n + 1;
    if(n == arrList.length){
        n = 0;
    }
    document.getElementById('textarea').innerHTML = arrList[n];
})
bgm.addEventListener('ended', function () {
    $('#play-btn').css('display','inline-block')
    $('#wait-btn').css('display','none')
	pauseImg.src='./images/play.png'
}, false);

bgm.addEventListener('waiting', function () {
    $('#play-btn').css('display','none')
    $('#wait-btn').css('display','inline-block')
    pauseImg.src='./images/pause.png'
    // bgm.pause()
}, false);

bgm.addEventListener('playing', function () {
    $('#play-btn').css('display','none')
    $('#wait-btn').css('display','inline-block')
	pauseImg.src='./images/pause.png'
}, false);
bgm.addEventListener('error', function () {
	console.log(bgm.error)
    if(bgm.error.code == 1 || bgm.error.code == 2 || bgm.error.code == 3 || bgm.error.code == 4){
        $('#textarea').val('此浏览器不支持音频播放')
	}
}, false);

var addWavHeader = function(samples,sampleRateTmp,sampleBits,channelCount){
    var dataLength = samples.byteLength;
    var buffer = new ArrayBuffer(44 + dataLength);
    var view = new DataView(buffer);
    function writeString(view, offset, string){
        for (var i = 0; i < string.length; i++){
            view.setUint8(offset + i, string.charCodeAt(i));
        }
    }
    var offset = 0;
    /* 资源交换文件标识符 */
    writeString(view, offset, 'RIFF'); offset += 4;
    /* 下个地址开始到文件尾总字节数,即文件大小-8 */
    view.setUint32(offset, /*32*/ 36 + dataLength, true); offset += 4;
    /* WAV文件标志 */
    writeString(view, offset, 'WAVE'); offset += 4;
    /* 波形格式标志 */
    writeString(view, offset, 'fmt '); offset += 4;
    /* 过滤字节,一般为 0x10 = 16 */
    view.setUint32(offset, 16, true); offset += 4;
    /* 格式类别 (PCM形式采样数据) */
    view.setUint16(offset, 1, true); offset += 2;
    /* 通道数 */
    view.setUint16(offset, channelCount, true); offset += 2;
    /* 采样率,每秒样本数,表示每个通道的播放速度 */
    view.setUint32(offset, sampleRateTmp, true); offset += 4;
    /* 波形数据传输率 (每秒平均字节数) 通道数×每秒数据位数×每样本数据位/8 */
    view.setUint32(offset, sampleRateTmp * channelCount * (sampleBits / 8), true); offset +=4;
    /* 快数据调整数 采样一次占用字节数 通道数×每样本的数据位数/8 */
    view.setUint16(offset, channelCount * (sampleBits / 8), true); offset += 2;
    /* 每样本数据位数 */
    view.setUint16(offset, sampleBits, true); offset += 2;
    /* 数据标识符 */
    writeString(view, offset, 'data'); offset += 4;
    /* 采样数据总数,即数据总大小-44 */
    view.setUint32(offset, dataLength, true); offset += 4;
    function floatTo32BitPCM(output, offset, input){
        input = new Int32Array(input);
        for (var i = 0; i < input.length; i++, offset+=4){
            output.setInt32(offset,input[i],true);
        }
    }
    function floatTo16BitPCM(output, offset, input){
        input = new Int16Array(input);
        for (var i = 0; i < input.length; i++, offset+=2){
            output.setInt16(offset,input[i],true);
        }
    }
    function floatTo8BitPCM(output, offset, input){
        input = new Int8Array(input);
        for (var i = 0; i < input.length; i++, offset++){
            output.setInt8(offset,input[i],true);
        }
    }
    if(sampleBits == 16){
        floatTo16BitPCM(view, 44, samples);
    }else if(sampleBits == 8){
        floatTo8BitPCM(view, 44, samples);
    }else{
        floatTo32BitPCM(view, 44, samples);
    }
    return view.buffer;
}
function XMLhttp(){
    var req = new XMLHttpRequest();
    var formData = 'text='+textv+'&user='+accountid
    req.open("POST", urlhead+'/cloudtts', true); // grab our audio file
    req.setRequestHeader('channel','cloudasr')
    req.setRequestHeader('lenovokey',lenkey)
    req.setRequestHeader('secretkey',secrkey)
    req.setRequestHeader('content-type', 'application/x-www-form-urlencoded')
    req.responseType = "arraybuffer";   // needs to be specific type to work
    req.overrideMimeType('text/xml; charset = utf-8')
    req.onload = function() {
        //根据pcm文件 填写 sampleRateTmp【采样率】（11025） 和sampleBits【采样精度】（16） channelCount【声道】（单声道1，双声道2）
        var fileResult = addWavHeader(req.response,11025,16,1);
        var blob = new Blob([fileResult], {type:'autio/wav'});
        bgm.src = URL.createObjectURL(blob);
        bgm.play();
        $('#wait-btn').css('display','inline-block')
        $('.loading').css('display','none')
        $('#play-img').css('display','inline-block')
    };
    req.send(formData);
}
function getCookie(name){
	var strcookie = document.cookie;//获取cookie字符串
	var arrcookie = strcookie.split("; ");//分割
	//遍历匹配
	for ( var i = 0; i < arrcookie.length; i++) {
		var arr = arrcookie[i].split("=");
		if (arr[0] == name){
			return arr[1];
		}
	}
	return "";
}
</script>                                       
</html>